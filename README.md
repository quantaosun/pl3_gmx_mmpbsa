# pl3_gmx_mmpbsa
Local Unix use or binder use

An example of the final result of such a calculation (per-residue decomposition of binding free energy)

![image](https://user-images.githubusercontent.com/75652473/230804988-ecd647c8-a10b-4140-9c63-fde93d2b6045.png)


[![Use on Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/quantaosun/pl3_gmx_mmpbsa/HEAD)

Recommened workflow.
1. Docking with pl3 as per https://github.com/quantaosun/pl3
2. MD input files generation with Charmm gui input generator (solution builder), with files generated by pl3
3. MD simulation with local gromacs or gmx inside this pl3_gmx_mmpbsa binder environment
```
modify REAMD for loop to only run the first 1, with step5.production.mdp nsteps extended 10 times of original value

```
4. MMPBSA calcultion of protein-ligand based on MD trajectories (and per-residue decomposition)
5. Visualisation and/or chart/imge making with gmx_MMPBSA_ana 



Elaboration on step 3, modify README to only run 1 nano second instead of 10, so the final trajectory only named as step5_1.xtc, and all mmpbsa calculation will be on the basis of step5_1


Elaboration on step 4. To know the index for protein and ligand, run

```
gmx make_ndx -f step5_1.gro -o index2.ndx

```
# In case the small molecules contains F Cl Br, it is necessary to delete the virtual site not supported by gmx_MMPBSA. 



To run mmpbsa calculation with decompositon 

```
gmx_MMPBSA -O -i mmpbsa.in -cs step5_1.tpr -ci index2.ndx -cg 1 13 -ct step5_1.xtc -cp topol.top -o FINAL_RESULTS.dat -eo FINAL_RESULTS.csv

```
where mmpbsa.in is 

```
&general
sys_name="Prot-Lig-ST",
startframe=1,
endframe=12,
/
&gb
igb=5, saltcon=0.150,
/

&decomp
idecomp=2, dec_verbose=3,
print_res="within 4"
/
```
To determine how many frames in your trajectory file, use pymol 
```
load step5_1.gro
load step5_1.xtc
```

In case the small molecule contains F Cl Br atoms, the command should be modified to 

```
gmx_MMPBSA -O -i mmpbsa.in -cs step5_1.tpr -ci index2.ndx -cg 1 17 -ct step5_1.xtc -cp topol.top -o FINAL_RESULTS.dat -eo FINAL_RESULTS.cs
```
See details from https://valdes-tresanco-ms.github.io/gmx_MMPBSA/dev/examples/Protein_ligand_LPH_atoms_CHARMMff/, note the modification of topol.top is extremely easy to go wrong, be careful.

# In case you have to use Bash instead of csh 
```
#!/bin/bash
#
# Generated by CHARMM-GUI (http://www.charmm-gui.org) v3.7
#
# This folder contains GROMACS formatted CHARMM36 force fields, a pre-optimized PDB structure, and GROMACS inputs.
# All input files were optimized for GROMACS 2019.2 or above, so lower version of GROMACS can cause some errors.
# We adopted the Verlet cut-off scheme for all minimization, equilibration, and production steps because it is 
# faster and more accurate than the group scheme. If you have a trouble with a performance of Verlet scheme while 
# running parallelized simulation, you should check if you are using appropriate command line.
# For MPI parallelizing, we recommand following command:
# mpirun -np $NUM_CPU gmx mdrun -ntomp 1

init="step3_input"
mini_prefix="step4.0_minimization"
equi_prefix="step4.1_equilibration"
prod_prefix="step5_production"
prod_step="step5"

# Minimization
# In the case that there is a problem during minimization using a single precision of GROMACS, please try to use 
# a double precision of GROMACS only for the minimization step.
#gmx grompp -f "${mini_prefix}.mdp" -o "${mini_prefix}.tpr" -c "${init}.gro" -r "${init}.gro" -p topol.top -n index.ndx -maxwarn -1
#gmx mdrun -v -deffnm "${mini_prefix}" -ntmpi 1


# Equilibration
#gmx grompp -f "${equi_prefix}.mdp" -o "${equi_prefix}.tpr" -c "${mini_prefix}.gro" -r "${init}.gro" -p topol.top -n index.ndx
#gmx mdrun -v -deffnm "${equi_prefix}" -ntmpi 1


# Production
cnt=1
cntmax=2

while [ $cnt -le $cntmax ]
do
    pcnt=$((cnt-1))
    istep="${prod_step}_${cnt}"
    pstep="${prod_step}_${pcnt}"

    if [ $cnt -eq 1 ]
    then
        pstep="${equi_prefix}"
        gmx grompp -f "${prod_prefix}.mdp" -o "${istep}.tpr" -c "${pstep}.gro" -p topol.top -n index.ndx
    else
        gmx grompp -f "${prod_prefix}.mdp" -o "${istep}.tpr" -c "${pstep}.gro" -t "${pstep}.cpt" -p topol.top -n index.ndx
    fi

    gmx mdrun -v -deffnm "${istep}" -ntmpi 1
    cnt=$((cnt+1))
done
```

